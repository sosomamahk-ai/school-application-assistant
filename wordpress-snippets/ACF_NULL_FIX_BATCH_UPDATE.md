# ACF Null 值修复工具 - 批量处理优化

## 更新说明

已优化 `fix-acf-null-values.php` 工具，解决修复模式下大量数据导致超时白屏的问题。

## 主要改进

### 1. 批量处理机制
- **预览模式**：可以一次性扫描更多文章（500篇）
- **修复模式**：使用批量处理，每次只处理 10 篇文章，自动分批完成
- 通过 AJAX 自动分批处理，避免单次请求超时

### 2. 进度追踪
- 实时显示修复进度条
- 显示累计统计信息（已扫描文章数、已修复字段数、错误数）
- 支持暂停和继续功能

### 3. 内存优化
- 修复模式下减少详细信息记录（只保留最新的100条）
- 扫描模式下保留更多详细信息（500条）
- 优化数据库操作，减少内存占用

### 4. 用户体验改进
- 修复模式下显示友好的进度界面
- 自动分批处理，无需手动操作
- 支持暂停/停止功能
- 清晰的统计和进度显示

## 使用方法

### 方法1：通过管理后台（推荐）

1. 登录 WordPress 后台
2. 进入 **工具 > ACF null 值修复**
3. 点击 **开始预览扫描** 查看需要修复的字段
4. 确认后点击 **确认执行批量修复**
5. 工具会自动分批处理，显示进度和统计信息

### 方法2：通过URL参数

- 预览模式：`?fix_acf_null=1`
- 修复模式：`?fix_acf_null=1&confirm=true`（不推荐，建议使用管理后台的批量处理）

## 技术细节

### 批量处理流程

1. **第一次扫描**（预览模式）：
   - 扫描最多 500 篇文章
   - 显示所有发现的 null 字段
   - 提供修复确认按钮

2. **批量修复**（修复模式）：
   - 每次通过 AJAX 处理 10 篇文章
   - 自动计算下一个批次的位置
   - 实时更新进度和统计
   - 处理完所有文章后自动完成

### 性能优化

- **批量大小**：修复模式每次处理 10 篇文章
- **详细信息限制**：修复模式只保留最新 100 条记录
- **输出刷新**：每处理 5 篇文章刷新一次输出
- **内存管理**：定期清理详细信息数组，避免内存溢出

### AJAX 接口

- **Action**: `acf_fix_batch`
- **参数**:
  - `offset`: 起始位置（默认 0）
  - `dry_run`: 是否为预览模式（true/false）
  - `nonce`: 安全验证

## 注意事项

1. **备份数据库**：在执行修复前，务必备份数据库
2. **大站点处理**：对于有大量文章的站点，修复过程可能需要较长时间，请耐心等待
3. **网络稳定性**：批量处理需要稳定的网络连接，建议在网络良好时执行
4. **暂停功能**：如需暂停，点击"暂停"按钮，然后可以继续处理

## 故障排除

### 问题：修复时出现白屏

**解决方案**：已通过批量处理机制解决。如果仍有问题，可以：
1. 减少批量大小（修改代码中的 `$batch_size = 10` 为更小的值，如 5）
2. 增加 PHP 执行时间限制
3. 检查服务器内存限制

### 问题：进度卡住不动

**解决方案**：
1. 检查浏览器控制台是否有错误
2. 检查服务器日志
3. 尝试刷新页面重新开始
4. 检查网络连接

### 问题：修复不完整

**解决方案**：
1. 检查是否有错误记录
2. 重新运行扫描，查看剩余需要修复的字段
3. 对于特定的文章或字段，可以手动修复

## 更新历史

- **v2.0**（当前版本）：添加批量处理机制，解决超时问题
- **v1.0**：初始版本，支持扫描和修复功能

