# 📚 零基础用户指南：如何同步学校数据

## 🎯 目标
同步WordPress中的所有学校数据到数据库，让所有学校都能显示`name_short`（学校简称）。

---

## 📋 准备工作

### 1. 确认你有管理员账户
- 你需要一个**管理员账户**（role必须是`admin`）
- 如果不知道，可以问开发人员或查看数据库

### 2. 确认开发服务器正在运行
打开命令行（PowerShell），运行：
```powershell
npm run dev
```
看到类似这样的输出就说明服务器在运行：
```
✓ Ready in 2.3s
○ Local: http://localhost:3000
```

---

## 🚀 方法一：使用一键脚本（最简单，推荐）

### 步骤1：打开PowerShell
1. 按 `Win键 + X`
2. 选择 "Windows PowerShell" 或 "终端"

### 步骤2：进入项目目录
在PowerShell中输入：
```powershell
cd C:\school-application-assistant
```
（如果你的项目在其他位置，改成你的实际路径）

### 步骤3：运行同步脚本
输入以下命令：
```powershell
.\scripts\sync-schools.ps1
```

### 步骤4：按提示输入信息
脚本会依次询问：
1. **管理员邮箱**：输入你的管理员邮箱，然后按回车
2. **密码**：输入你的密码（输入时不会显示，这是正常的），然后按回车

### 步骤5：等待完成
脚本会自动：
- 登录你的账户
- 调用同步API
- 显示同步结果

你会看到类似这样的输出：
```
========================================
WordPress学校数据同步
========================================

步骤1: 正在登录...
✅ 登录成功！用户: admin@example.com

步骤2: 正在同步WordPress学校数据...
这可能需要几分钟时间，请耐心等待...

========================================
✅ 同步完成！
========================================

同步结果:
  ✓ 成功同步: 150 所学校
  ⚠ 错误数量: 0
  ⏱ 耗时: 5234ms

下一步: 访问 /schools 页面验证所有学校都显示了 name_short
```

---

## 🖥️ 方法二：手动在浏览器中操作（适合不熟悉命令行的用户）

### 步骤1：登录管理员账户
1. 打开浏览器（Chrome、Edge等）
2. 访问：`http://localhost:3000/auth/login`
3. 输入你的管理员邮箱和密码
4. 点击"登录"

### 步骤2：打开开发者工具
1. 登录成功后，按 `F12` 键（或右键页面 → 选择"检查"）
2. 点击顶部的 **"Console"（控制台）** 标签

### 步骤3：复制并运行代码
在Console中输入以下代码（一行一行复制，或者全部复制后粘贴）：

```javascript
// 获取token
const token = localStorage.getItem('token');

// 检查是否有token
if (!token) {
  console.log('❌ 未找到token，请确保已登录');
} else {
  console.log('✅ 找到token，开始同步...');
  
  // 调用同步API
  fetch('/api/admin/sync-schools', {
    method: 'POST',
    headers: {
      'Authorization': 'Bearer ' + token,
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    console.log('========================================');
    console.log('✅ 同步完成！');
    console.log('========================================');
    console.log('成功同步:', data.synced, '所学校');
    console.log('错误数量:', data.errors);
    console.log('耗时:', data.duration);
    
    if (data.errorsList && data.errorsList.length > 0) {
      console.log('错误列表:', data.errorsList);
    }
  })
  .catch(error => {
    console.error('❌ 同步失败:', error);
  });
}
```

### 步骤4：查看结果
在Console中会显示同步结果，类似这样：
```
✅ 找到token，开始同步...
========================================
✅ 同步完成！
========================================
成功同步: 150 所学校
错误数量: 0
耗时: 5234ms
```

---

## 🔧 方法三：使用PowerShell命令（适合熟悉命令行的用户）

### 步骤1：打开PowerShell
按 `Win键 + X`，选择 "Windows PowerShell"

### 步骤2：进入项目目录
```powershell
cd C:\school-application-assistant
```

### 步骤3：登录获取token
运行以下命令（替换成你的邮箱和密码）：
```powershell
$loginResponse = Invoke-RestMethod -Uri "http://localhost:3000/api/auth/login" -Method POST -ContentType "application/json" -Body (@{identifier="你的邮箱@example.com";password="你的密码"} | ConvertTo-Json)
$token = $loginResponse.token
Write-Host "Token: $token"
```

### 步骤4：调用同步API
```powershell
$result = Invoke-RestMethod -Uri "http://localhost:3000/api/admin/sync-schools" -Method POST -Headers @{Authorization="Bearer $token";"Content-Type"="application/json"}
Write-Host "同步了 $($result.synced) 所学校"
```

---

## ✅ 验证同步是否成功

### 方法1：查看数据库（需要数据库工具）
如果你有数据库访问权限，运行：
```sql
SELECT COUNT(*) FROM "School" WHERE "nameShort" IS NOT NULL;
```
应该显示一个数字（比如150），表示有多少学校有`name_short`。

### 方法2：查看前端页面（最简单）
1. 打开浏览器
2. 访问：`http://localhost:3000/schools`
3. 查看学校列表
4. **每个学校名称下方应该显示学校简称（name_short）**

如果所有学校都显示了简称，说明同步成功！

### 方法3：查看API响应
在浏览器中访问：
```
http://localhost:3000/api/schools
```
查看返回的JSON数据，每个学校对象都应该有`nameShort`字段。

---

## ❌ 常见问题解决

### 问题1：提示"403 Forbidden"或"不是管理员"
**原因**：你的账户不是管理员
**解决**：
1. 联系开发人员将你的账户设置为管理员
2. 或者在数据库中手动修改：
   ```sql
   UPDATE "User" SET role = 'admin' WHERE email = '你的邮箱';
   ```

### 问题2：提示"401 Unauthorized"或"未授权"
**原因**：Token无效或过期
**解决**：
1. 重新登录
2. 重新获取token
3. 再次运行同步

### 问题3：提示"找不到脚本"
**原因**：脚本文件不存在或路径不对
**解决**：
1. 确认文件存在：`scripts\sync-schools.ps1`
2. 确认你在项目根目录：`C:\school-application-assistant`
3. 如果文件不存在，从`HOW_TO_CALL_SYNC_API.md`中复制脚本内容创建文件

### 问题4：同步很慢或超时
**原因**：WordPress数据量大或网络慢
**解决**：
1. 耐心等待（可能需要几分钟）
2. 检查WordPress API是否可访问
3. 查看服务器日志了解详细错误

### 问题5：PowerShell提示"无法运行脚本"
**原因**：PowerShell执行策略限制
**解决**：
```powershell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```
然后选择 `Y` 确认

---

## 📞 需要帮助？

如果遇到问题：
1. 查看 `HOW_TO_CALL_SYNC_API.md` 了解详细技术说明
2. 查看服务器日志（在运行`npm run dev`的终端中）
3. 联系开发人员

---

## 🎉 完成后的下一步

同步完成后：
1. ✅ 访问 `/schools` 页面验证所有学校都显示了`name_short`
2. ✅ 访问 `/admin/templates-v2` 页面验证模板列表
3. ✅ 如果发现问题，可以再次运行同步脚本

---

## 📝 快速参考

**最简单的方法**：
```powershell
cd C:\school-application-assistant
.\scripts\sync-schools.ps1
```
然后输入邮箱和密码即可。

**浏览器方法**：
1. 登录 → 按F12 → Console标签
2. 粘贴代码 → 回车
3. 查看结果

