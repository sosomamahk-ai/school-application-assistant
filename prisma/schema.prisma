generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id               String            @id @default(cuid())
  email            String            @unique
  password         String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  role             String            @default("user")
  username         String?           @unique
  profile          UserProfile?
  userApplications UserApplication[]
  fieldMappings    FieldMapping[]
}

model UserProfile {
  id              String        @id @default(cuid())
  userId          String        @unique
  fullName        String?
  phone           String?
  birthday        DateTime?
  nationality     String?
  educationData   Json?
  experiencesData Json?
  essaysData      Json?
  additionalData  Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  applications    Application[]
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SchoolFormTemplate {
  id                  String        @id @default(cuid())
  schoolId            String        @unique
  schoolName          String
  program             String
  description         String?
  fieldsData          Json
  isActive            Boolean       @default(true)
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  category            String?       @default("国际学校")
  applicationStartDate DateTime?
  applicationEndDate  DateTime?
  applications        Application[]
  school              School?
}

model School {
  id                    String             @id @default(cuid())
  name                  String
  shortName             String?
  nameShort             String?
  wpId                  Int?               @unique
  templateId            String?            @unique
  template              SchoolFormTemplate? @relation(fields: [templateId], references: [id], onDelete: Cascade)
  campusLocation        String?
  gradeRange            String?
  applicationStart      DateTime?
  applicationEnd        DateTime?
  interviewTime         DateTime?
  examTime              DateTime?
  resultTime            DateTime?
  requiredDocuments     Json?
  requirements          Json?
  officialLink          String?
  permalink             String?
  overviewWebsiteSchool String?
  notes                 String?
  metadataSource        String?
  metadataLastFetchedAt DateTime?
  profileType            String?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  userApplications      UserApplication[]

  @@index([applicationEnd])
  @@index([applicationStart])
  @@index([wpId])
  @@index([templateId])
}

model Application {
  id                   String             @id @default(cuid())
  profileId            String
  templateId           String
  formData             Json
  status               String             @default("draft")
  targetSubmissionDate DateTime?
  interviewDate        DateTime?
  writtenTestDate      DateTime?
  resultDate           DateTime?
  progressNotes        String?
  timelineOverrides    Json?
  reminderSettings     Json?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  submittedAt          DateTime?
  profile              UserProfile        @relation(fields: [profileId], references: [id], onDelete: Cascade)
  template             SchoolFormTemplate @relation(fields: [templateId], references: [id], onDelete: NoAction)
  userApplication      UserApplication?

  @@index([profileId])
  @@index([templateId])
}

model AIConversation {
  id            String   @id @default(cuid())
  userId        String
  applicationId String?
  messages      Json
  context       Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
}

model ApplicationData {
  id        String   @id @default(cuid())
  schoolId  String
  userId    String
  data      Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, userId])
  @@index([schoolId])
  @@index([userId])
}

model UserApplication {
  id               String    @id @default(cuid())
  userId           String
  schoolId         String
  applicationId    String?   @unique
  fillingProgress  Int       @default(0)
  interviewTime    DateTime?
  examTime         DateTime?
  result           String    @default("pending")
  resultTime       DateTime?
  reminderSettings Json?
  notes            String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  school      School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  application Application? @relation(fields: [applicationId], references: [id])

  @@unique([userId, schoolId])
  @@index([schoolId])
  @@index([userId])
}

model FieldMapping {
  id           String   @id @default(cuid())
  userId       String
  domain       String
  selector     String
  domId        String?
  domName      String?
  profileField String
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id])

  @@unique([userId, domain, selector])
}

model WordPressProfileCache {
  id           String   @id @default("current")
  rawData      Json
  lastSyncedAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([lastSyncedAt])
}
