generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model AIConversation {
  id            String   @id
  userId        String
  applicationId String?
  messages      Json
  context       Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime

  @@index([userId])
}

model Application {
  id                   String             @id
  profileId            String
  templateId           String
  formData             Json
  status               String             @default("draft")
  createdAt            DateTime           @default(now())
  updatedAt            DateTime
  submittedAt          DateTime?
  targetSubmissionDate DateTime?
  interviewDate        DateTime?
  writtenTestDate      DateTime?
  resultDate           DateTime?
  progressNotes        String?
  timelineOverrides    Json?
  reminderSettings     Json?
  profile              UserProfile        @relation(fields: [profileId], references: [id], onDelete: Cascade)
  template             SchoolFormTemplate @relation(fields: [templateId], references: [id], onDelete: NoAction)
  userApplication      UserApplication?

  @@index([profileId])
  @@index([templateId])
}

model ApplicationData {
  id        String   @id
  schoolId  String
  userId    String
  data      Json
  createdAt DateTime @default(now())
  updatedAt DateTime

  @@unique([schoolId, userId])
  @@index([schoolId])
  @@index([userId])
}

model FieldMapping {
  id           String   @id
  userId       String
  domain       String
  selector     String
  domId        String?
  domName      String?
  profileField String
  createdAt    DateTime @default(now())
  User         User     @relation(fields: [userId], references: [id])

  @@unique([userId, domain, selector])
}

model School {
  id                    String              @id
  name                  String
  shortName             String?
  templateId            String?             @unique
  campusLocation        String?
  gradeRange            String?
  applicationStart      DateTime?
  applicationEnd        DateTime?
  interviewTime         DateTime?
  examTime              DateTime?
  resultTime            DateTime?
  requiredDocuments     Json?
  requirements          Json?
  officialLink          String?
  notes                 String?
  metadataSource        String?
  metadataLastFetchedAt DateTime?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime
  overviewWebsiteSchool String?
  permalink             String?
  nameShort             String?
  wpId                  Int?
  nameEnglish           String?
  country               String?
  location              String?
  bandType              String?
  school_profile_type   String? // ACF 字段: acf.school_profile_type
  profileType           String? // Taxonomy 字段: taxonomy.profile_type
  postType              String? // WordPress post type: 'profile' | 'university'
  template              SchoolFormTemplate? @relation(fields: [templateId], references: [id], onDelete: Cascade)
  UserApplication       UserApplication[]
  scripts               Script[]

  @@index([applicationEnd])
  @@index([applicationStart])
  @@index([templateId])
  @@index([wpId])
}

model SchoolFormTemplate {
  id                       String        @id
  schoolId                 String        @unique
  schoolName               String
  program                  String
  description              String?
  fieldsData               Json
  isActive                 Boolean       @default(true)
  createdAt                DateTime      @default(now())
  updatedAt                DateTime
  category                 String?       @default("国际学校")
  // General "Open All Year" option
  isApplicationOpenAllYear Boolean       @default(false)
  // Standard dates (for International Schools and others)
  applicationStartDate     DateTime?
  applicationEndDate       DateTime?
  // University dates (Early Decision + Regular Decision)
  earlyStartDate           DateTime?
  earlyEndDate             DateTime?
  regularStartDate         DateTime?
  regularEndDate           DateTime?
  // Local Primary/Secondary School dates (Spring Transfer + Fall Transfer + Central Allocation)
  springStartDate          DateTime?
  springEndDate            DateTime?
  fallStartDate            DateTime?
  fallEndDate              DateTime?
  centralStartDate         DateTime?
  centralEndDate           DateTime?
  Application              Application[]
  school                   School?
}

model User {
  id              String            @id
  email           String            @unique
  password        String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  role            String            @default("user")
  username        String?           @unique
  FieldMapping    FieldMapping[]
  UserApplication UserApplication[]
  profile         UserProfile?
}

model UserApplication {
  id               String       @id
  userId           String
  schoolId         String
  applicationId    String?      @unique
  fillingProgress  Int          @default(0)
  interviewTime    DateTime?
  examTime         DateTime?
  result           String       @default("pending")
  resultTime       DateTime?
  reminderSettings Json?
  notes            String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime
  application      Application? @relation(fields: [applicationId], references: [id])
  school           School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, schoolId])
  @@index([schoolId])
  @@index([userId])
}

model UserProfile {
  id              String        @id
  userId          String        @unique
  fullName        String?
  phone           String?
  birthday        DateTime?
  nationality     String?
  educationData   Json?
  experiencesData Json?
  essaysData      Json?
  additionalData  Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime
  Application     Application[]
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model WordPressProfileCache {
  id           String   @id @default("current")
  rawData      Json
  lastSyncedAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime

  @@index([lastSyncedAt])
}

model Script {
  id        Int      @id @default(autoincrement())
  schoolId  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
}
