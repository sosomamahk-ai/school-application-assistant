# 同步错误处理指南

## 错误信息：500 内部服务器错误 - "Sync completed with errors"

### 这是什么意思？

这个错误表示：
- ✅ **同步过程已经运行**
- ✅ **部分学校已经成功同步**
- ⚠️ **部分学校同步失败**

**这不是完全失败**，而是部分成功！

## 如何检查结果

### 方法1：使用Prisma Studio（最简单）

```powershell
npx prisma studio
```

1. 打开浏览器（会自动打开）
2. 点击 "School" 表
3. 查看记录数量
4. 筛选 `wpId IS NOT NULL` 查看已同步的学校

**如果看到接近1962条记录，说明大部分都成功了！**

### 方法2：查看服务器日志

在运行 `npm run dev` 的终端中，查找：
- `[syncAllWPSchools] ✅ Sync completed: X synced, Y errors`
- `[syncAllWPSchools] Error syncing school XXX: ...`

这些日志会告诉你：
- 成功同步了多少所学校
- 哪些学校失败了
- 失败的原因

### 方法3：检查数据库

如果你有数据库访问权限：

```sql
-- 检查已同步的学校数量
SELECT COUNT(*) FROM "School" WHERE "wpId" IS NOT NULL;

-- 检查有name_short的学校数量
SELECT COUNT(*) FROM "School" WHERE "nameShort" IS NOT NULL;

-- 查看最近的同步记录
SELECT "wpId", "name", "nameShort", "metadataLastFetchedAt" 
FROM "School" 
WHERE "wpId" IS NOT NULL 
ORDER BY "metadataLastFetchedAt" DESC 
LIMIT 10;
```

## 常见错误原因

### 1. 唯一约束冲突（Duplicate wpId）
**原因**：数据库中已存在相同的wpId
**解决**：这是正常的，同步会更新现有记录

### 2. 数据库连接超时
**原因**：同步时间太长，数据库连接超时
**解决**：重新运行同步（已存在的会被更新）

### 3. 缺少必填字段
**原因**：某些学校数据不完整
**解决**：检查WordPress数据，确保所有必填字段都有值

### 4. 网络问题
**原因**：WordPress API响应慢或超时
**解决**：重新运行同步，失败的会重试

## 如何处理

### 情况1：大部分学校已同步（推荐）

如果已同步了大部分学校（比如1800+）：

1. **检查已同步的数量**（使用Prisma Studio）
2. **重新运行同步脚本**：
   ```powershell
   .\scripts\sync-schools-with-retry.ps1
   ```
   
   重新运行是安全的：
   - 已存在的学校会被更新（不会重复）
   - 只会同步失败的学校

### 情况2：很少或没有学校同步

如果同步的数量很少（比如<100）：

1. **检查服务器日志**，查看具体错误
2. **检查数据库连接**：
   ```powershell
   npm run test:db
   ```
3. **检查环境变量**：
   ```powershell
   npm run check:env
   ```
4. **查看详细错误**（在dev服务器终端）

### 情况3：特定学校一直失败

如果某些学校一直失败：

1. **查看错误列表**（在服务器日志中）
2. **检查这些学校的WordPress数据**是否完整
3. **手动修复**或跳过这些学校

## 优化后的错误处理

我已经更新了代码：
- ✅ 即使有错误，也会返回200状态码（如果部分成功）
- ✅ 显示详细的错误列表
- ✅ 显示成功和失败的数量

## 验证同步结果

同步完成后（即使有错误），验证：

1. **检查数据库**：
   ```powershell
   npx prisma studio
   ```
   查看School表，应该有接近1962条记录

2. **检查前端**：
   - 访问 `http://localhost:3002/schools`
   - 查看学校列表
   - 大部分学校应该显示 `name_short`

3. **如果还有缺失的**：
   - 重新运行同步脚本
   - 只会同步缺失的学校

## 快速检查命令

```powershell
# 1. 检查已同步数量
npx prisma studio

# 2. 查看错误分析
.\scripts\check-sync-errors.ps1

# 3. 重新运行同步（如果部分失败）
.\scripts\sync-schools-with-retry.ps1
```

## 总结

- **500错误 + "Sync completed with errors" = 部分成功**
- **检查已同步的数量**（使用Prisma Studio）
- **如果大部分成功，重新运行同步即可**
- **重新运行是安全的**（不会重复创建）

