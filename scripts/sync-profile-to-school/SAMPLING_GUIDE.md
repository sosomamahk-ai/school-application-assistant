# 抽样同步模式使用指南

## 概述

抽样同步模式是正式同步全部数据前的验证阶段，通过随机抽样少量记录进行完整同步流程测试，快速验证脚本逻辑的可靠性。

## 为什么使用抽样模式？

在同步大量数据之前，抽样模式可以帮助您：

1. **快速验证脚本逻辑**: 只需几秒钟就能测试完整流程
2. **发现配置问题**: 在同步大量数据前发现 ACF、taxonomy、认证等问题
3. **验证字段映射**: 确认字段映射是否正确
4. **检查数据质量**: 了解 WordPress 数据的完整性
5. **降低风险**: 避免在发现问题时已同步大量错误数据

## 使用方法

### 基本用法

```bash
# 抽样 20 条记录，不修改数据库（推荐首次使用）
npm run sync:profile-to-school -- --sample 20 --dry-run

# 抽样 20 条记录，实际同步到数据库
npm run sync:profile-to-school -- --sample 20

# 抽样 50 条记录
npm run sync:profile-to-school -- --sample 50
```

### 参数说明

- `--sample <数量>`: 指定抽样数量（例如 `--sample 20`）
- `--dry-run`: 可选，dry-run 模式下不修改数据库

## 工作原理

### 1. 获取所有 Post IDs

脚本首先使用轻量查询获取所有 profile post IDs：

```bash
GET /wp-json/wp/v2/profile?_fields=id&per_page=100
```

这种方式只获取 ID 字段，响应速度快，即使有数百条记录也能快速获取。

### 2. 随机抽样

使用 Fisher-Yates shuffle 算法随机选择指定数量的 IDs。这确保了：
- 每个 post 被选中的概率相等
- 抽样结果具有代表性

### 3. 获取详细信息

对抽样的 IDs 逐条请求完整信息（包括 `_embed` 参数以获取 taxonomy terms）：

```bash
GET /wp-json/wp/v2/profile/<id>?_embed
```

### 4. 执行完整同步流程

对每条抽样的 post 执行完整的同步流程：
- ✅ 字段提取（ACF、taxonomy、post 字段）
- ✅ 字段诊断（分析缺失字段的原因）
- ✅ 数据库 upsert（创建或更新）
- ✅ 日志记录

### 5. 生成详细报告

生成包含以下信息的抽样报告：
- 抽样统计（数量、成功、失败）
- 缺失字段统计
- 字段诊断详情
- 失败率警告
- 下一步操作建议

## 抽样报告解读

### 正常情况示例

```
═══════════════════════════════════════════════════════════
抽样同步报告 (Sample Sync Report)
═══════════════════════════════════════════════════════════
抽样数量: 20
总可用记录数: 150
成功同步数量: 20
失败数量: 0
缺失字段记录数: 2
失败率: 0.0%

缺失字段统计:
  nameEnglish: 2 条记录缺失
```

✅ **成功同步数量 = 抽样数量**: 所有记录都成功同步  
✅ **失败率 = 0%**: 没有错误  
⚠️ **少量字段缺失是正常的**: 如果只是 2-3 条记录缺少非关键字段，可以继续

### 需要关注的情况

```
失败率: 15.0%
缺失字段统计:
  profileType: 15 条记录缺失  ← 超过 50%
```

⚠️ **失败率超过阈值（10%）**: 需要检查配置  
⚠️ **关键字段缺失率超过 50%**: 可能存在系统性问题

脚本会输出警告：

```
⚠️⚠️⚠️  重要警告 ⚠️⚠️⚠️
抽样同步发现失败率 15.0% 超过阈值 10%
建议在同步全部数据前先检查 WordPress 配置和脚本设置。
```

## 常见场景

### 场景 1: 首次使用

```bash
# 1. 抽样 20 条测试（dry-run）
npm run sync:profile-to-school -- --sample 20 --dry-run

# 2. 检查报告，如果正常：
npm run sync:profile-to-school -- --sample 20  # 实际同步测试

# 3. 使用 Prisma Studio 验证数据

# 4. 如果一切正常，同步全部数据
npm run sync:profile-to-school
```

### 场景 2: 发现问题

如果抽样报告显示问题：

1. **ACF 字段缺失**: 检查 ACF to REST API 插件是否启用
2. **Taxonomy 缺失**: 检查 taxonomy 是否已关联到 post
3. **认证失败**: 检查认证配置是否正确
4. **数据库错误**: 检查 Prisma schema 和连接配置

使用报告中提供的 curl 命令进行验证：

```bash
curl 'http://localhost:3000/wp-json/wp/v2/profile/123?_embed' | jq '.acf'
```

解决问题后，再次运行抽样测试。

### 场景 3: 检查特定字段

如果想检查特定字段的缺失情况：

```bash
npm run sync:profile-to-school -- --sample 50 --dry-run
```

查看报告中的 "缺失字段统计" 部分。

## 最佳实践

### 1. 首次使用

```bash
# 先抽样测试
npm run sync:profile-to-school -- --sample 20 --dry-run

# 检查报告，确认无严重问题后再实际同步
```

### 2. 修改配置后

如果修改了字段映射或配置：

```bash
# 重新抽样测试
npm run sync:profile-to-school -- --sample 20 --dry-run
```

### 3. 定期验证

定期运行抽样测试，确保 WordPress 数据质量：

```bash
# 每月抽样测试
npm run sync:profile-to-school -- --sample 30 --dry-run
```

### 4. 问题排查

当发现问题时，使用抽样模式快速验证修复：

```bash
# 修复问题后，快速验证
npm run sync:profile-to-school -- --sample 10 --dry-run
```

## 注意事项

### 1. 抽样不会自动继续

抽样模式结束后，脚本**不会自动继续**同步全部数据。需要手动执行：

```bash
npm run sync:profile-to-school
```

这可以避免在发现问题时误写大量错误数据。

### 2. 抽样数量建议

- **首次使用**: 20 条（快速验证）
- **验证配置**: 50 条（更全面的测试）
- **问题排查**: 10 条（快速验证修复）

### 3. 失败率阈值

默认失败率阈值为 10%。如果失败率超过阈值，脚本会：
- 输出警告
- 建议检查配置
- 不阻止继续，但强烈建议先解决问题

可以通过环境变量自定义阈值：

```env
SAMPLE_FAILURE_THRESHOLD=0.15  # 15% 阈值
```

### 4. Dry Run 模式

在抽样模式下也支持 dry-run：

```bash
npm run sync:profile-to-school -- --sample 20 --dry-run
```

这样可以测试完整流程但不修改数据库。

## 故障排查

### 问题: 抽样数量大于总数

如果指定的抽样数量大于可用的记录数，脚本会返回所有记录。

### 问题: 获取 IDs 失败

检查：
- WordPress API 是否可访问
- 认证配置是否正确
- 网络连接是否正常

### 问题: 抽样后所有字段都缺失

可能是：
- ACF to REST API 插件未启用
- REST API 端点配置错误
- 认证权限不足

查看诊断报告中的建议和 curl 命令。

## 示例输出

完整示例输出请参考 `README.md` 中的"抽样同步模式详细说明"部分。

