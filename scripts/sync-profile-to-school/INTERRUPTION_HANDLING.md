# 中断处理说明

## ✅ 已同步的数据会保存

**好消息**：如果同步过程中断开，**已经成功同步的记录会保存在数据库中，不会丢失**。

### 原因

1. **每条记录独立保存**：
   - 每条记录的 `upsert` 操作都是独立的
   - 成功后会立即写入数据库
   - 不使用全局事务包裹所有操作

2. **幂等性保证**：
   - 使用 `upsert` 操作（update or insert）
   - 如果记录已存在，会更新；不存在则创建
   - 重复运行不会导致数据重复或错误

3. **立即提交**：
   - 每条记录同步成功后立即提交到数据库
   - 不会等到所有记录处理完才批量提交

## 🔄 重新运行的行为

如果中断后重新运行同步脚本：

### 当前行为

**会重新处理所有记录**，包括已经同步的：
- ✅ 已同步的记录：会重新获取并更新（使用 upsert，不会重复创建）
- ✅ 未同步的记录：会继续同步
- ⚠️ 会重新处理所有记录，包括已完成的

### 影响

- ✅ **数据安全**：不会丢失已同步的数据
- ✅ **数据正确**：重复运行会确保数据最新
- ⚠️ **时间消耗**：会重新处理所有记录（包括已同步的）

## 🎯 推荐的恢复策略

### 方案 1: 直接重新运行（最简单）

```bash
# 直接重新运行，会重新处理所有记录
npm run sync:profile-to-school:resync-all
```

**优点**：
- ✅ 简单直接
- ✅ 确保所有数据都是最新的
- ✅ 不会遗漏任何记录

**缺点**：
- ⚠️ 会重新处理所有记录（包括已同步的）

### 方案 2: 跳过最近同步的记录（优化）

如果想节省时间，可以跳过最近同步的记录。检查同步日志或数据库中的 `metadataLastFetchedAt` 字段来确定哪些记录最近已同步。

```bash
# 查看最近的同步记录
# 可以使用 Prisma Studio 查看 metadataLastFetchedAt 字段

# 然后使用重新同步脚本，只处理较旧的记录
npm run sync:profile-to-school:resync -- --all
```

## 📊 如何验证中断前的进度

### 方法 1: 查看数据库记录

```bash
npx prisma studio
```

在 `School` 表中：
- 查看 `metadataLastFetchedAt` 字段：最近同步的记录会有最近的日期
- 查看 `school_profile_type` 和 `profileType` 字段：已同步的记录会有值

### 方法 2: 使用验证脚本

```bash
npm run sync:profile-to-school:verify
```

查看已填充字段的记录数，了解同步进度。

## 🔍 中断后继续同步的示例

假设同步到 500 条时中断：

```bash
# 1. 验证已同步的记录
npm run sync:profile-to-school:verify
# 输出：school_profile_type 已填充: 500 条

# 2. 重新运行同步（会处理所有记录，包括已同步的）
npm run sync:profile-to-school:resync-all

# 3. 完成后再次验证
npm run sync:profile-to-school:verify
# 输出：school_profile_type 已填充: 1962 条
```

## ⚠️ 注意事项

1. **不要手动删除记录**：
   - 如果中断，不要手动删除部分同步的记录
   - 直接重新运行脚本即可，upsert 会正确处理

2. **网络稳定性**：
   - 建议在网络稳定时运行
   - 如果频繁中断，考虑分批执行

3. **数据库连接**：
   - 脚本会自动重试数据库连接
   - 但如果连接持续失败，已同步的数据已安全保存

## 🚀 最佳实践

### 如果同步过程中中断：

1. **不要担心**：已同步的数据已保存
2. **重新运行**：直接重新运行同步脚本
3. **验证结果**：完成后验证同步状态

### 如果频繁中断：

考虑使用分批同步：

```bash
# 方式 1: 使用重新同步脚本分批
npm run sync:profile-to-school:resync -- --all --limit 500

# 方式 2: 使用主同步脚本（会自动分页）
npm run sync:profile-to-school
```

## 📝 总结

- ✅ **已同步的数据会保存**：每条记录成功后立即写入数据库
- ✅ **可以安全重新运行**：使用 upsert，不会导致数据重复
- ✅ **数据不会丢失**：已完成的同步不会因中断而回滚
- ⚠️ **会重新处理所有记录**：包括已同步的（但这是安全的）

**建议**：如果中断，直接重新运行同步脚本即可，不用担心数据丢失！

