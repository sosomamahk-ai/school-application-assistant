# 自动申请功能使用指南

## 功能概述

自动申请功能可以自动填写并提交学校的在线申请表单，大大节省手动填写的时间。系统使用 Playwright 自动化浏览器操作，为每个学校创建专门的脚本。

## 快速开始：为新学校添加自动申请功能

### 场景示例：为"上海国际学校"添加自动申请

#### 步骤 1：准备信息

在开始之前，需要收集以下信息：

1. **学校ID** (schoolId)
   - 登录系统，进入"可申请学校"页面
   - 找到目标学校，查看数据库中的 `schoolId`
   - 例如：`shanghai-international-school`

2. **申请页面URL**
   - 访问学校的申请页面
   - 记录完整的URL
   - 例如：`https://shanghai-school.edu/apply`

3. **是否需要登录**
   - 申请前是否需要先登录
   - 如果需要，记录登录页面URL

#### 步骤 2：创建脚本文件

**方法一：使用脚本生成工具（推荐）**

```bash
# 在项目根目录运行
node scripts/create-school-script.js shanghai-international-school "上海国际学校" "https://shanghai-school.edu/apply"
```

这会自动创建一个模板脚本文件。

**方法二：手动创建**

1. 在 `src/modules/auto-apply/schools/` 目录下创建新文件
2. 文件名：`shanghai-international-school.ts`（使用学校ID作为文件名）

#### 步骤 3：编写脚本内容

打开刚创建的脚本文件，根据实际情况修改：

```typescript
import type { SchoolAutomationScript } from "../engine/types";

const APPLY_URL = "https://shanghai-school.edu/apply";

export const shanghaiInternationalSchoolScript: SchoolAutomationScript = {
  id: "shanghai-international-school", // ⚠️ 必须与数据库中的 schoolId 完全匹配
  name: "上海国际学校",
  supportsLogin: false, // 如果需要登录，改为 true
  description: "上海国际学校自动申请脚本",
  
  async run(ctx) {
    const { utils, formFiller, payload, page, logger } = ctx;
    
    try {
      // 1. 打开申请页面
      logger.info("打开申请页面");
      await utils.safeNavigate(page, APPLY_URL);
      await utils.waitForNetworkIdle(page);
      
      // 2. 自动填写表单（系统会自动匹配字段）
      logger.info("开始填写表单");
      await formFiller.fillFields(page, payload.template.fields);
      
      // 3. 提交表单
      const submitBtn = page.getByRole("button", { name: /提交|submit|确认/i });
      if (await submitBtn.count()) {
        await submitBtn.click();
        await page.waitForNavigation();
      }
      
      return { 
        success: true, 
        message: "申请已成功提交" 
      };
    } catch (error) {
      logger.error("申请失败", { error });
      return {
        success: false,
        message: (error as Error).message,
      };
    }
  },
};
```

#### 步骤 4：注册脚本

在 `src/modules/auto-apply/autoApplyService.ts` 文件中：

1. 导入新脚本：
```typescript
import { shanghaiInternationalSchoolScript } from "./schools/shanghai-international-school";
```

2. 注册到脚本注册表：
```typescript
const scriptRegistry: SchoolScriptMap = {
  [exampleSchoolScript.id]: exampleSchoolScript,
  [shanghaiInternationalSchoolScript.id]: shanghaiInternationalSchoolScript, // 添加这一行
};
```

#### 步骤 5：测试脚本

1. **设置环境变量**

   创建或编辑 `.env.local` 文件：
   ```
   PLAYWRIGHT_HEADLESS=false
   AUTO_APPLY_SCREENSHOTS=tmp/auto-apply
   ```

   - `PLAYWRIGHT_HEADLESS=false` 表示显示浏览器窗口，方便观察操作过程
   - `AUTO_APPLY_SCREENSHOTS` 指定截图保存目录

2. **启动开发服务器**

   ```bash
   npm run dev
   ```

3. **在前端测试**

   - 登录系统
   - 进入"可申请学校"页面
   - 找到"上海国际学校"
   - 点击"自动申请"按钮
   - 观察浏览器自动打开并执行操作

4. **检查结果**

   - 如果成功：页面会显示成功消息
   - 如果失败：查看浏览器控制台和服务器日志

## 常见问题处理

### 问题 1：字段无法自动匹配

**现象**：某些字段没有被正确填写

**原因**：模板中的字段ID与页面上的标签不匹配

**解决方法**：使用字段映射

```typescript
import { remapTemplateFields } from "./common";

// 在 run 函数中
const overrides = remapTemplateFields(payload.template, {
  // 模板字段ID -> 页面标签
  english_first_name: { label: "First Name" },
  english_last_name: { label: "Last Name" },
  student_email: { label: "Email Address" },
});

const fields = overrides.length ? overrides : payload.template.fields;
await formFiller.fillFields(page, fields);
```

### 问题 2：需要登录

**现象**：页面要求先登录才能申请

**解决方法**：

1. 在脚本中设置 `supportsLogin: true`
2. 实现登录逻辑：

```typescript
export const schoolScript: SchoolAutomationScript = {
  id: "school-id",
  supportsLogin: true, // 设置为 true
  async run(ctx) {
    const { loginHandler, payload, page, utils } = ctx;
    
    // 如果需要登录
    if (payload.userLogin) {
      // 方法1：使用标准登录处理器
      await loginHandler.maybeLogin(page, payload.userLogin);
      
      // 方法2：自定义登录逻辑
      // await utils.safeNavigate(page, LOGIN_URL);
      // await page.fill('input[name="email"]', payload.userLogin.email || '');
      // await page.fill('input[name="password"]', payload.userLogin.password || '');
      // await page.click('button[type="submit"]');
      // await page.waitForNavigation();
    }
    
    // 继续申请流程...
  },
};
```

### 问题 3：多步骤表单

**现象**：表单分多页，需要逐步填写

**解决方法**：

```typescript
// 第一步
await formFiller.fillFields(page, step1Fields);
await page.click('button:has-text("下一步")');
await page.waitForNavigation();

// 第二步
await formFiller.fillFields(page, step2Fields);
await page.click('button:has-text("下一步")');
await page.waitForNavigation();

// 最后提交
await page.click('button:has-text("提交")');
await page.waitForNavigation();
```

### 问题 4：需要上传文件

**解决方法**：

```typescript
// 上传文件
const fileInput = page.locator('input[type="file"]');
if (await fileInput.count()) {
  // 文件路径可以从 payload.metadata 中获取
  const filePath = payload.metadata?.resumePath || '/path/to/file.pdf';
  await fileInput.setInputFiles(filePath);
}
```

### 问题 5：提交按钮找不到

**现象**：脚本无法找到提交按钮

**解决方法**：添加更多选择器

```typescript
async function locateSubmitButton(page: Page): Promise<Locator | null> {
  const candidates = [
    page.getByRole("button", { name: /提交|submit|确认|apply/i }),
    page.locator('button[type="submit"]'),
    page.locator('input[type="submit"]'),
    page.locator('#submit-button'), // 根据实际页面调整
    page.locator('.submit-btn'),    // 根据实际页面调整
    page.locator('button.submit'),   // 根据实际页面调整
  ];

  for (const locator of candidates) {
    if (await locator.count()) {
      return locator.first();
    }
  }
  return null;
}
```

## 调试技巧

### 1. 查看浏览器操作

设置 `PLAYWRIGHT_HEADLESS=false` 后，可以看到浏览器自动操作的过程，方便发现问题。

### 2. 查看日志

服务器控制台会输出详细日志，查找 `[auto-apply]` 开头的消息：

```
[auto-apply] 导航到申请页面 { url: 'https://...' }
[auto-apply] 开始填写表单 { fieldCount: 10 }
[auto-apply] 找到提交按钮，准备提交
```

### 3. 查看错误截图

如果出错，系统会自动截图并保存到 `tmp/auto-apply/` 目录，可以查看截图了解出错时的页面状态。

### 4. 添加自定义日志

在脚本中添加日志，帮助调试：

```typescript
logger.info("当前步骤", { 
  url: page.url(),
  fieldCount: fields.length,
  pageTitle: await page.title()
});
```

## 完整操作流程示例

### 场景：为"北京国际学校"添加自动申请

1. **准备阶段**
   ```bash
   # 1. 确认学校ID（假设是 beijing-international-school）
   # 2. 确认申请URL（假设是 https://beijing-school.edu/apply）
   # 3. 确认是否需要登录（假设不需要）
   ```

2. **创建脚本**
   ```bash
   node scripts/create-school-script.js beijing-international-school "北京国际学校" "https://beijing-school.edu/apply"
   ```

3. **编辑脚本**
   - 打开 `src/modules/auto-apply/schools/beijing-international-school.ts`
   - 根据实际页面调整代码
   - 如果需要字段映射，添加映射规则

4. **注册脚本**
   - 在 `autoApplyService.ts` 中导入并注册

5. **测试**
   ```bash
   # 设置环境变量
   export PLAYWRIGHT_HEADLESS=false
   
   # 启动服务器
   npm run dev
   
   # 在前端测试
   ```

6. **部署**
   - 提交代码到版本控制
   - 部署到生产环境
   - 监控执行日志

## 检查清单

创建新脚本前，确认：

- [ ] 学校ID与数据库中的 `schoolId` 完全匹配
- [ ] 申请URL正确且可访问
- [ ] 脚本已注册到 `autoApplyService.ts`
- [ ] 已测试基本流程（打开页面、填写字段、提交）
- [ ] 已处理错误情况
- [ ] 已添加必要的日志
- [ ] 如果需要登录，已实现登录逻辑
- [ ] 如果有特殊字段，已处理（文件上传、日期选择等）

## 获取帮助

如果遇到问题：

1. **查看详细文档**：`docs/AUTO_APPLY_SCRIPT_GUIDE.md`
2. **查看快速开始**：`docs/AUTO_APPLY_QUICK_START.md`
3. **参考示例脚本**：`src/modules/auto-apply/schools/example-school.ts`
4. **检查服务器日志**：查看控制台输出
5. **查看错误截图**：检查 `tmp/auto-apply/` 目录

## 总结

添加新学校的自动申请功能主要步骤：

1. ✅ 收集学校信息（ID、URL、是否需要登录）
2. ✅ 创建脚本文件（使用工具或手动创建）
3. ✅ 编写自动化逻辑
4. ✅ 注册脚本
5. ✅ 测试和调试
6. ✅ 部署和监控

每个学校的脚本都是独立的，可以根据具体需求定制。如果遇到问题，参考本文档的"常见问题处理"部分。

