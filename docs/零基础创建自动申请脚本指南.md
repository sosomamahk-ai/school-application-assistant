# 零基础创建自动申请脚本 - 超详细指南

## 📋 目录

1. [准备工作](#准备工作)
2. [方法一：使用Web界面创建（推荐，最简单）](#方法一使用web界面创建推荐最简单)
3. [方法二：手动创建脚本（高级用户）](#方法二手动创建脚本高级用户)
4. [测试脚本](#测试脚本)
5. [常见问题](#常见问题)

---

## ⚡ 快速开始（推荐方法）

**如果您是零基础用户，强烈推荐使用方法一（Web界面），只需3步即可完成！**

1. 登录系统 → 进入"自动申请脚本管理"页面
2. 点击"创建新脚本" → 填写学校信息和申请URL
3. 点击"创建脚本" → 完成！

系统会自动：
- ✅ 创建脚本文件
- ✅ 注册脚本到系统
- ✅ 配置基本参数

---

## 方法一：使用Web界面创建（推荐，最简单）

### 步骤 1：打开管理页面

1. **登录系统**
   - 访问：`http://localhost:3000`（开发环境）
   - 或您的生产环境地址
   - 使用管理员账号登录

2. **进入自动申请脚本管理页面**
   - 点击顶部导航栏的"管理"或"Admin"
   - 选择"自动申请脚本管理"
   - 或直接访问：`http://localhost:3000/admin/auto-apply-scripts`

### 步骤 2：找到学校信息

在创建脚本之前，您需要知道：

1. **学校ID**（schoolId）
   - 在管理页面，系统会自动列出所有可用的学校模板
   - 选择学校时，会显示学校ID
   - 例如：`shanghai-international-school`

2. **申请页面URL**
   - 打开浏览器，访问学校的官方网站
   - 找到"申请"或"Apply"链接
   - 复制完整的URL
   - 例如：`https://shanghai-school.edu/apply`

3. **是否需要登录**
   - 如果打开申请页面后，直接显示申请表单 → **不需要登录**
   - 如果打开申请页面后，要求先登录 → **需要登录**

### 步骤 3：创建脚本

1. **点击"创建新脚本"按钮**
   - 页面右上角的蓝色按钮

2. **填写表单**
   - **选择学校**：从下拉列表中选择要创建脚本的学校
   - **申请页面URL**：粘贴您复制的申请URL
   - **需要登录**：如果申请前需要登录，勾选此选项

3. **点击"创建脚本"按钮**
   - 系统会自动：
     - ✅ 创建脚本文件
     - ✅ 注册脚本到系统
     - ✅ 配置基本参数

4. **查看结果**
   - 如果成功，会显示绿色成功消息
   - 脚本会出现在列表中，显示"已注册"状态

### 完成！

脚本已经创建并注册完成，您现在可以：

1. **测试脚本**（见下方"测试脚本"部分）
2. **查看脚本文件**（如果需要自定义）
   - 文件位置：`src/modules/auto-apply/schools/您的学校ID.ts`

---

## 方法二：手动创建脚本（高级用户）

---

## 准备工作

### 需要准备的工具

1. **代码编辑器**（推荐使用 VS Code）
   - 下载地址：https://code.visualstudio.com/
   - 如果已经安装，可以跳过

2. **终端/命令行工具**
   - Windows: PowerShell 或 CMD
   - Mac: Terminal（终端）
   - 如果不知道是什么，不用担心，我会详细说明

3. **项目文件**
   - 确保您已经下载了 school-application-assistant 项目
   - 知道项目文件夹在哪里

---

## 第一步：找到学校信息

### 1.1 找到学校ID

**方法一：通过数据库查看（推荐）**

1. 打开项目文件夹
2. 在项目根目录打开终端（见下方"如何打开终端"）
3. 运行以下命令：
   ```bash
   npx prisma studio
   ```
4. 浏览器会自动打开一个页面（通常是 http://localhost:5555）
5. 点击左侧的 `SchoolFormTemplate`
6. 找到您要添加自动申请的学校
7. 查看 `schoolId` 这一列，**复制这个值**（例如：`shanghai-international-school`）

**方法二：通过代码查看**

1. 打开项目文件夹
2. 找到文件：`src/pages/schools/index.tsx`
3. 打开这个文件，查看学校列表
4. 或者查看数据库种子文件：`prisma/seed.ts`

### 1.2 找到申请URL

1. **打开浏览器**，访问学校的官方网站
2. **找到申请页面**（通常是"申请"、"Apply"、"在线申请"等链接）
3. **复制完整的URL**（例如：`https://shanghai-school.edu/apply`）
4. **记录是否需要登录**：
   - 如果打开申请页面后，直接显示申请表单 → **不需要登录**
   - 如果打开申请页面后，要求先登录 → **需要登录**

### 如何打开终端（Windows）

1. **方法一：在VS Code中打开**
   - 打开VS Code
   - 点击顶部菜单：`终端` → `新建终端`
   - 或者按快捷键：`Ctrl + ~`（Ctrl键 + 波浪号键）

2. **方法二：在文件夹中打开**
   - 在项目文件夹中，按住 `Shift` 键
   - 右键点击空白处
   - 选择"在此处打开PowerShell窗口"或"在此处打开命令窗口"

3. **方法三：直接打开PowerShell**
   - 按 `Win + X` 键
   - 选择"Windows PowerShell"或"终端"

### 如何打开终端（Mac）

1. **方法一：在VS Code中打开**
   - 打开VS Code
   - 点击顶部菜单：`Terminal` → `New Terminal`
   - 或者按快捷键：`Ctrl + ~`

2. **方法二：直接打开终端**
   - 按 `Cmd + 空格键` 打开Spotlight搜索
   - 输入"Terminal"
   - 按回车键

---

## 第二步：创建脚本文件

### 2.1 使用脚本生成工具（最简单）

1. **打开终端**（参考上面的方法）

2. **进入项目文件夹**
   ```bash
   cd C:\school-application-assistant
   ```
   > 注意：把 `C:\school-application-assistant` 替换成您的实际项目路径

3. **运行生成命令**
   ```bash
   node scripts/create-school-script.js shanghai-international-school "上海国际学校" "https://shanghai-school.edu/apply"
   ```
   > 注意：把参数替换成您的实际信息
   > - `shanghai-international-school` → 您的学校ID
   > - `"上海国际学校"` → 您的学校名称
   > - `"https://shanghai-school.edu/apply"` → 您的申请URL

4. **查看结果**
   - 如果成功，会显示：`✅ 脚本文件已创建: ...`
   - 文件位置：`src/modules/auto-apply/schools/您的学校ID.ts`

### 2.2 手动创建文件（如果工具不工作）

1. **打开VS Code**（或其他代码编辑器）

2. **打开项目文件夹**
   - 文件 → 打开文件夹
   - 选择 `school-application-assistant` 文件夹

3. **导航到脚本目录**
   - 在左侧文件列表中，依次打开：
     - `src`
     - `modules`
     - `auto-apply`
     - `schools`

4. **创建新文件**
   - 右键点击 `schools` 文件夹
   - 选择"新建文件"
   - 输入文件名：`您的学校ID.ts`（例如：`shanghai-international-school.ts`）
   - 按回车确认

5. **复制模板代码**
   - 打开文件：`src/modules/auto-apply/schools/example-school.ts`
   - 复制所有内容
   - 粘贴到您刚创建的新文件中
   - 修改以下内容：
     - `id: "example-school"` → `id: "您的学校ID"`
     - `name: "Example International School"` → `name: "您的学校名称"`
     - `APPLY_URL = "https://example.edu/apply"` → `APPLY_URL = "您的申请URL"`

---

## 第三步：填写脚本内容

### 3.1 打开脚本文件

1. 在VS Code中，打开刚创建的脚本文件
2. 文件路径：`src/modules/auto-apply/schools/您的学校ID.ts`

### 3.2 理解脚本结构

脚本文件包含以下几个部分：

```typescript
// 1. 导入必要的工具
import type { SchoolAutomationScript } from "../engine/types";

// 2. 定义申请URL
const APPLY_URL = "https://您的学校.edu/apply";

// 3. 定义脚本对象
export const 您的学校Script: SchoolAutomationScript = {
  id: "您的学校ID",           // ⚠️ 必须与数据库中的schoolId完全一致
  name: "您的学校名称",
  supportsLogin: false,      // 如果需要登录，改为 true
  description: "描述",
  
  // 4. 主要执行函数
  async run(ctx) {
    // 这里写自动化逻辑
  },
};
```

### 3.3 填写基本脚本（最简单版本）

**如果您的学校申请页面很简单（不需要登录，直接填写表单）：**

```typescript
import type { SchoolAutomationScript } from "../engine/types";

const APPLY_URL = "https://您的学校.edu/apply";

export const 您的学校Script: SchoolAutomationScript = {
  id: "您的学校ID",  // ⚠️ 必须与数据库中的schoolId完全一致
  name: "您的学校名称",
  supportsLogin: false,
  description: "您的学校自动申请脚本",
  
  async run(ctx) {
    const { utils, formFiller, payload, page, logger } = ctx;
    
    try {
      // 1. 打开申请页面
      logger.info("打开申请页面");
      await utils.safeNavigate(page, APPLY_URL);
      await utils.waitForNetworkIdle(page);
      
      // 2. 自动填写表单
      // ⭐ 这里会自动将您的申请表资料填进学校的申请系统
      logger.info("开始填写表单");
      await formFiller.fillFields(page, payload.template.fields);
      
      // 3. 提交表单
      const submitBtn = page.getByRole("button", { name: /提交|submit|确认|apply/i });
      if (await submitBtn.count()) {
        await submitBtn.click();
        await page.waitForNavigation();
      }
      
      return { 
        success: true, 
        message: "申请已成功提交" 
      };
    } catch (error) {
      logger.error("申请失败", { error });
      return {
        success: false,
        message: (error as Error).message,
      };
    }
  },
};
```

**关键说明：**

- `payload.template.fields` 包含了您在学校申请系统中填写的所有资料
- `formFiller.fillFields()` 会自动将这些资料填写到学校的申请页面
- 系统会自动匹配字段（通过标签、占位符等）

### 3.4 如果需要登录

如果申请前需要先登录，修改如下：

```typescript
export const 您的学校Script: SchoolAutomationScript = {
  id: "您的学校ID",
  name: "您的学校名称",
  supportsLogin: true,  // ⚠️ 改为 true
  description: "您的学校自动申请脚本",
  
  async run(ctx) {
    const { utils, formFiller, loginHandler, payload, page, logger } = ctx;
    
    try {
      // 1. 打开申请页面
      await utils.safeNavigate(page, APPLY_URL);
      await utils.waitForNetworkIdle(page);
      
      // 2. 如果需要登录，先登录
      if (payload.userLogin) {
        logger.info("执行登录");
        await loginHandler.maybeLogin(page, payload.userLogin);
        await utils.waitForNetworkIdle(page);
      }
      
      // 3. 填写表单
      await formFiller.fillFields(page, payload.template.fields);
      
      // 4. 提交
      const submitBtn = page.getByRole("button", { name: /提交|submit/i });
      if (await submitBtn.count()) {
        await submitBtn.click();
        await page.waitForNavigation();
      }
      
      return { success: true, message: "申请已提交" };
    } catch (error) {
      logger.error("申请失败", { error });
      return {
        success: false,
        message: (error as Error).message,
      };
    }
  },
};
```

### 3.5 如何将申请表资料与学校申请系统联系起来

**这是自动完成的！** 您不需要手动做任何映射。

**工作原理：**

1. **您的申请表资料**存储在数据库中，包含字段如：
   - `english_first_name`（英文名）
   - `student_email`（邮箱）
   - `student_phone`（电话）
   - 等等...

2. **系统自动匹配**：
   - 系统会查看学校申请页面上每个字段的**标签**（Label）
   - 例如：页面上有"First Name"标签的输入框
   - 系统会尝试匹配您的`english_first_name`字段
   - 如果标签匹配，就自动填写

3. **匹配规则**：
   - 优先匹配：字段标签（Label）
   - 其次匹配：占位符（Placeholder）
   - 再次匹配：aria-label属性
   - 最后匹配：字段ID

**如果自动匹配失败怎么办？**

如果某些字段无法自动匹配，可以手动指定映射：

```typescript
import { remapTemplateFields } from "./common";

// 在 run 函数中，填写表单之前添加：
const overrides = remapTemplateFields(payload.template, {
  // 您的字段ID -> 页面上的标签
  english_first_name: { label: "First Name" },
  english_last_name: { label: "Last Name" },
  student_email: { label: "Email Address" },
});

const fields = overrides.length ? overrides : payload.template.fields;
await formFiller.fillFields(page, fields);
```

---

## 第四步：注册脚本

### 4.1 找到注册文件

1. 在VS Code中，打开文件：
   ```
   src/modules/auto-apply/autoApplyService.ts
   ```

### 4.2 添加导入语句

1. **找到文件顶部的导入部分**（大约第1-13行）
2. **在最后一行导入后面添加**：
   ```typescript
   import { 您的学校Script } from "./schools/您的学校ID";
   ```
   
   例如：
   ```typescript
   import { exampleSchoolScript } from "./schools/example-school";
   import { shanghaiInternationalSchoolScript } from "./schools/shanghai-international-school";  // 添加这一行
   ```

### 4.3 注册到脚本表

1. **找到 `scriptRegistry` 对象**（大约第44-46行）
2. **在对象中添加您的脚本**：
   ```typescript
   const scriptRegistry: SchoolScriptMap = {
     [exampleSchoolScript.id]: exampleSchoolScript,
     [您的学校Script.id]: 您的学校Script,  // 添加这一行
   };
   ```
   
   例如：
   ```typescript
   const scriptRegistry: SchoolScriptMap = {
     [exampleSchoolScript.id]: exampleSchoolScript,
     [shanghaiInternationalSchoolScript.id]: shanghaiInternationalSchoolScript,
   };
   ```

### 4.4 保存文件

- 按 `Ctrl + S`（Windows）或 `Cmd + S`（Mac）保存

---

## 第五步：测试脚本

### 5.1 设置环境变量

**什么是环境变量？**
- 环境变量是告诉程序如何运行的配置
- 我们需要设置一个变量，让浏览器显示出来（方便观察）

**如何设置（Windows）：**

1. **在项目根目录创建文件**：`.env.local`
   - 如果文件已存在，直接打开
   - 如果不存在，创建新文件

2. **添加以下内容**：
   ```
   PLAYWRIGHT_HEADLESS=false
   AUTO_APPLY_SCREENSHOTS=tmp/auto-apply
   ```

3. **保存文件**

**如何设置（Mac/Linux）：**

1. 打开终端
2. 进入项目目录
3. 运行：
   ```bash
   echo 'PLAYWRIGHT_HEADLESS=false' >> .env.local
   echo 'AUTO_APPLY_SCREENSHOTS=tmp/auto-apply' >> .env.local
   ```

### 5.2 启动开发服务器

1. **打开终端**（参考第一步的方法）

2. **进入项目目录**
   ```bash
   cd C:\school-application-assistant
   ```
   > 替换成您的实际路径

3. **启动服务器**
   ```bash
   npm run dev
   ```

4. **等待启动完成**
   - 看到类似 `ready - started server on 0.0.0.0:3000` 的消息
   - 表示启动成功

5. **如果出错**：
   - 确保已经安装了依赖：`npm install`
   - 确保Node.js版本 >= 18

### 5.3 在前端测试

1. **打开浏览器**
   - 访问：`http://localhost:3000`
   - 或者查看终端显示的地址

2. **登录系统**
   - 使用您的账号登录

3. **进入可申请学校页面**
   - 点击导航栏的"可申请学校"或类似链接
   - 或者直接访问：`http://localhost:3000/schools`

4. **找到您的学校**
   - 在列表中找到您刚添加脚本的学校

5. **点击"自动申请"按钮**
   - 浏览器会自动打开（因为设置了 `PLAYWRIGHT_HEADLESS=false`）
   - 观察自动填写和提交的过程

6. **查看结果**
   - 如果成功：页面会显示成功消息
   - 如果失败：查看浏览器控制台和服务器日志

### 5.4 查看日志

**服务器日志**（在终端中）：
- 查找 `[auto-apply]` 开头的消息
- 这些是脚本执行的详细日志

**错误截图**：
- 如果出错，截图会保存在：`tmp/auto-apply/` 目录
- 可以查看截图了解出错时的页面状态

---

## 常见问题

### Q1: 找不到终端/命令行在哪里？

**A**: 
- Windows: 按 `Win + X`，选择"Windows PowerShell"
- Mac: 按 `Cmd + 空格`，搜索"Terminal"
- 或者在VS Code中：`终端` → `新建终端`

### Q2: 运行 `npm run dev` 报错？

**A**: 
- 确保已经安装了依赖：`npm install`
- 确保Node.js版本 >= 18：`node --version`
- 如果还是不行，把错误信息发给我

### Q3: 脚本执行失败，字段没有填写？

**A**: 
- 检查字段映射（参考第三步的3.5节）
- 查看服务器日志中的错误信息
- 查看截图（`tmp/auto-apply/` 目录）

### Q4: 不知道学校ID是什么？

**A**: 
- 使用 `npx prisma studio` 查看数据库
- 或者查看 `prisma/seed.ts` 文件

### Q5: 脚本文件在哪里？

**A**: 
- 路径：`src/modules/auto-apply/schools/`
- 文件名：`您的学校ID.ts`

### Q6: 如何知道字段是否匹配成功？

**A**: 
- 查看服务器日志，会有字段匹配的信息
- 如果匹配失败，会显示错误信息
- 可以设置 `PLAYWRIGHT_HEADLESS=false` 观察浏览器操作

---

## 总结

创建自动申请脚本的完整流程：

1. ✅ **找到学校信息**（ID、URL、是否需要登录）
2. ✅ **创建脚本文件**（使用工具或手动创建）
3. ✅ **填写脚本内容**（复制模板并修改）
4. ✅ **注册脚本**（在 autoApplyService.ts 中）
5. ✅ **测试脚本**（设置环境变量、启动服务器、测试）

**关键点：**
- 学校ID必须与数据库中的完全一致
- 脚本会自动匹配字段，无需手动映射（大多数情况）
- 测试时设置 `PLAYWRIGHT_HEADLESS=false` 可以看到浏览器操作

如果还有问题，请告诉我具体在哪一步遇到了困难！

