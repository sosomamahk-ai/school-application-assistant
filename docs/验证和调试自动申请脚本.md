# 验证和调试自动申请脚本功能

## 🔍 快速验证步骤

### 步骤1：运行验证脚本

在项目根目录运行：
```bash
node scripts/verify-auto-apply-scripts.js
```

如果所有检查通过，继续下一步。

### 步骤2：检查生产环境部署

**问题：生产环境404**

可能原因：
1. 新文件还没有部署到生产环境
2. Vercel构建失败
3. 文件路径不正确

**解决方法**：

1. **检查Git提交**
   ```bash
   git status
   git log --oneline -5
   ```
   确认新文件已提交

2. **检查Vercel部署**
   - 登录 Vercel 控制台
   - 查看最新部署状态
   - 检查构建日志是否有错误
   - 确认部署包含新文件

3. **手动触发部署**
   - 在Vercel控制台点击"Redeploy"
   - 或推送一个空提交：
     ```bash
     git commit --allow-empty -m "Trigger deployment"
     git push
     ```

### 步骤3：检查用户角色

**问题：导航栏没有显示链接**

可能原因：
1. 用户不是管理员角色
2. localStorage中的用户信息不正确

**解决方法**：

1. **检查当前用户角色**
   - 打开浏览器控制台（F12）
   - 运行以下代码：
     ```javascript
     const user = JSON.parse(localStorage.getItem('user') || '{}');
     console.log('用户角色:', user.role);
     console.log('完整用户信息:', user);
     ```

2. **如果是普通用户，需要升级为管理员**
   - 方法1：通过数据库直接修改
     ```sql
     UPDATE "User" SET role = 'admin' WHERE email = 'your-email@example.com';
     ```
   - 方法2：通过管理员账号在系统中修改
     - 访问：`/admin/users`
     - 找到您的账号
     - 修改角色为"admin"

3. **重新登录**
   - 退出登录
   - 清除localStorage：
     ```javascript
     localStorage.clear();
     ```
   - 重新登录

### 步骤4：测试路由

1. **测试测试页面**
   - 访问：`https://sosomama.com/admin/auto-apply-scripts-test`
   - 如果这个页面能访问，说明路由配置正常
   - 如果也404，说明文件没有部署

2. **测试主页面**
   - 访问：`https://sosomama.com/admin/auto-apply-scripts`
   - 检查是否能正常访问

3. **检查浏览器控制台**
   - 按F12打开开发者工具
   - 查看Console标签页的错误信息
   - 查看Network标签页，检查API请求

## 🛠️ 详细诊断

### 诊断1：检查文件是否部署

在浏览器控制台运行：
```javascript
// 检查页面文件是否存在
fetch('/admin/auto-apply-scripts')
  .then(r => {
    console.log('状态码:', r.status);
    if (r.status === 404) {
      console.log('❌ 页面文件未部署或路径错误');
    } else {
      console.log('✅ 页面文件存在');
    }
  })
  .catch(e => console.error('错误:', e));
```

### 诊断2：检查API是否可用

在浏览器控制台运行：
```javascript
// 检查API是否可用
const token = localStorage.getItem('token');
fetch('/api/admin/auto-apply-scripts', {
  headers: { Authorization: `Bearer ${token}` }
})
  .then(r => {
    console.log('API状态码:', r.status);
    return r.json();
  })
  .then(data => {
    console.log('API响应:', data);
    if (data.scripts) {
      console.log('✅ API正常工作，找到', data.scripts.length, '个脚本');
    }
  })
  .catch(e => console.error('API错误:', e));
```

### 诊断3：检查用户权限

在浏览器控制台运行：
```javascript
// 检查用户信息和权限
const user = JSON.parse(localStorage.getItem('user') || '{}');
const token = localStorage.getItem('token');

console.log('用户信息:', user);
console.log('用户角色:', user.role);
console.log('是否管理员:', user.role === 'admin');
console.log('Token存在:', !!token);

// 检查导航链接是否应该显示
if (user.role === 'admin') {
  console.log('✅ 应该显示管理员导航链接');
} else {
  console.log('❌ 不是管理员，不会显示管理员导航链接');
  console.log('💡 需要将用户角色改为"admin"');
}
```

## 🔧 常见问题解决

### 问题1：生产环境404

**症状**：`https://sosomama.com/admin/auto-apply-scripts` 显示404

**可能原因**：
1. 文件没有提交到Git
2. Vercel没有部署新文件
3. 构建失败

**解决步骤**：
1. 确认文件已提交：
   ```bash
   git status
   git log --oneline --all | head -5
   ```

2. 检查Vercel部署日志
3. 手动触发重新部署

### 问题2：导航栏没有链接

**症状**：登录后看不到"自动申请脚本"链接

**可能原因**：
1. 用户不是管理员
2. localStorage中的用户信息不正确

**解决步骤**：
1. 检查用户角色（见上面的诊断3）
2. 如果是普通用户，升级为管理员
3. 清除缓存并重新登录

### 问题3：API请求失败

**症状**：页面能打开，但显示错误或无法加载数据

**可能原因**：
1. 未登录或token过期
2. 不是管理员账号
3. API路由有问题

**解决步骤**：
1. 检查是否已登录
2. 检查用户角色
3. 查看浏览器Network标签页的错误信息
4. 查看服务器日志

## ✅ 完整验证清单

- [ ] 运行验证脚本：`node scripts/verify-auto-apply-scripts.js`
- [ ] 确认所有文件已提交到Git
- [ ] 确认Vercel已部署最新代码
- [ ] 确认使用管理员账号登录
- [ ] 检查用户角色是否为"admin"
- [ ] 访问测试页面：`/admin/auto-apply-scripts-test`
- [ ] 访问主页面：`/admin/auto-apply-scripts`
- [ ] 检查导航菜单是否显示链接
- [ ] 测试创建脚本功能
- [ ] 检查浏览器控制台是否有错误

## 📞 获取帮助

如果以上步骤都无法解决问题：

1. **收集信息**：
   - 浏览器控制台的错误信息
   - Vercel部署日志
   - 用户角色信息
   - 网络请求的响应

2. **检查文件**：
   - 确认文件在Git仓库中
   - 确认Vercel构建成功
   - 确认文件路径正确

3. **联系支持**：
   - 提供收集到的信息
   - 描述具体的问题现象
   - 说明已尝试的解决方法

