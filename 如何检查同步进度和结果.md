# 如何检查同步进度和结果

## 问题：连接超时

你遇到的错误 "基础连接已经关闭" 是因为：
- 同步1962所学校需要很长时间（15-30分钟）
- HTTP连接默认超时时间较短
- 服务器在同步完成前关闭了连接

## 解决方案

### 方案1：使用新的重试脚本（推荐）

我已经创建了一个新的脚本，有更长的超时时间：

```powershell
.\scripts\sync-schools-with-retry.ps1
```

这个脚本：
- 超时时间设置为30分钟（1800秒）
- 会显示更详细的错误信息
- 如果超时，会提示你如何检查进度

### 方案2：检查已同步的数量

即使连接超时，同步可能仍在后台进行。检查方法：

#### 方法A：使用Prisma Studio（最简单）

```powershell
npx prisma studio
```

这会打开一个网页界面，你可以：
1. 点击 "School" 表
2. 查看有多少条记录
3. 筛选 `wpId IS NOT NULL` 来查看已同步的学校

#### 方法B：使用数据库工具

如果你有数据库访问权限，运行：

```sql
SELECT COUNT(*) FROM "School" WHERE "wpId" IS NOT NULL;
```

这会显示已同步的学校数量。

### 方案3：查看服务器日志

在运行 `npm run dev` 的终端中，查看是否有：
- `[syncAllWPSchools] Progress: X/1962` 这样的进度日志
- `[syncAllWPSchools] ✅ Sync completed` 完成日志

如果有完成日志，说明同步已经成功，只是连接超时了。

## 如果同步部分完成

如果同步了一部分但连接超时了：

1. **检查已同步数量**（使用上面的方法）
2. **重新运行同步**：
   ```powershell
   .\scripts\sync-schools-with-retry.ps1
   ```
   
   重新运行是安全的，因为：
   - 已存在的学校会被更新（不会重复创建）
   - 只会同步缺失的学校

## 优化建议

对于1962所学校，建议：

1. **分批同步**（如果连接经常超时）：
   - 可以修改代码，每次同步500所学校
   - 多次运行直到全部完成

2. **使用后台任务**：
   - 将同步改为后台任务
   - 通过API查询进度

3. **增加服务器超时**：
   - 在Vercel等平台增加函数超时时间
   - 或使用长时间运行的任务队列

## 快速检查命令

```powershell
# 1. 检查已同步数量（使用Prisma Studio）
npx prisma studio

# 2. 重新运行同步（使用新脚本）
.\scripts\sync-schools-with-retry.ps1

# 3. 查看服务器日志
# 在运行 npm run dev 的终端中查看
```

## 总结

- **连接超时是正常的**（对于大量数据）
- **同步可能仍在后台进行**
- **使用Prisma Studio检查进度**
- **重新运行同步是安全的**（不会重复创建）

